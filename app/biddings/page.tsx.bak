"use client";

import React, { Suspense, useCallback, useEffect, useMemo, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { useWriteContract } from "wagmi";
import { formatUnits, parseUnits, isAddress, zeroAddress } from "viem";
import { createPublicClient, http } from "viem";
import { auctionAbi, erc20Abi } from "@/lib/contracts";
import { useRequireWallet } from "@/lib/hooks/useWalletConnection";
import { WalletStatusBanner, ChainIndicator } from "../components/WalletStatus";
import Header from "../components/Header";
import PhaseProgressBar from "../components/PhaseProgressBar";

type SvgProps = { className?: string };

const IconShield = ({ className = "" }: SvgProps) => (
  <svg viewBox="0 0 24 24" aria-hidden="true" className={className} fill="none">
    <path
      d="M12 3 5 6v6c0 4.6 3 7.9 7 9 4-1.1 7-4.4 7-9V6l-7-3Z"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinejoin="round"
    />
    <path
      d="m9.5 12.2 1.8 1.8 3.4-3.8"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
);

const IconClock = ({ className = "" }: SvgProps) => (
  <svg viewBox="0 0 24 24" aria-hidden="true" className={className} fill="none">
    <circle cx="12" cy="12" r="8" stroke="currentColor" strokeWidth="1.6" />
    <path
      d="M12 7v5l3 2"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
);

const IconGavel = ({ className = "" }: SvgProps) => (
  <svg viewBox="0 0 24 24" aria-hidden="true" className={className} fill="none">
    <path d="M9.5 6.5 17 14" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" />
    <path
      d="m12 4 4 4-2 2-4-4 2-2Z"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinejoin="round"
    />
    <path
      d="m6 10 4 4-2 2-4-4 2-2Z"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinejoin="round"
    />
    <path d="M4 20h10" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" />
  </svg>
);

const IconWallet = ({ className = "" }: SvgProps) => (
  <svg viewBox="0 0 24 24" aria-hidden="true" className={className} fill="none">
    <path
      d="M4 7h13a3 3 0 0 1 3 3v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinejoin="round"
    />
    <path
      d="M16 12h4v4h-4a2 2 0 0 1 0-4Z"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinejoin="round"
    />
    <path
      d="M4 7V6a2 2 0 0 1 2-2h9"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinecap="round"
    />
  </svg>
);

const IconWithdraw = ({ className = "" }: SvgProps) => (
  <svg viewBox="0 0 24 24" aria-hidden="true" className={className} fill="none">
    <path
      d="M12 19V5m0 0-5 5m5-5 5 5"
      stroke="currentColor"
      strokeWidth="1.6"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
  </svg>
);

// ============ HELPERS ============

const formatUsdc = (amount: bigint | null) => {
  if (amount === null) return "-";
  return Number(formatUnits(amount, 6)).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

const shortAddr = (s: string) => (s && s.length > 12 ? `${s.slice(0, 6)}...${s.slice(-4)}` : s || "-");

const formatTimeRemaining = (seconds: bigint | null) => {
  if (seconds === null) return "-";
  const s = Number(seconds);
  if (s <= 0) return "Phase complete";
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m ${sec}s`;
  return `${sec}s`;
};

// ============ COMPONENT ============

function AuctionBidPageContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { writeContractAsync } = useWriteContract();

  // Use centralized wallet connection hook
  const {
    address: walletAddress,
    isConnected,
    contracts,
    chainMeta,
    connectionStatus,
    isChainMismatch,
    switchToChain,
    activeChainId,
    isSwitching,
    canTransact,
  } = useRequireWallet();

  const auctionAddressParam = searchParams.get("auction");
  const hasSession = isConnected && !!walletAddress;

  const ui = useMemo(
    () => ({
      bg: "bg-[#07090A]",
      card: "bg-white/[0.04] border border-white/[0.08] shadow-[0_18px_60px_rgba(0,0,0,0.55)]",
      cardInner: "bg-black/30 border border-white/[0.08]",
      pill: "bg-[#0B1516] border border-[#2DD4D4]/35 text-[#7DEAEA]",
      pillMuted: "bg-white/[0.03] border border-white/[0.08] text-white/70",
      teal: "#2DD4D4",
    }),
    []
  );

  const publicClient = useMemo(
    () => createPublicClient({ chain: chainMeta.chain, transport: http(chainMeta.rpcDefault) }),
    [chainMeta]
  );

  // Auction State
  const [auctionPhase, setAuctionPhase] = useState<number | null>(null);
  const [auctionLeader, setAuctionLeader] = useState("");
  const [auctionHighBid, setAuctionHighBid] = useState<bigint | null>(null);
  const [auctionFloorPrice, setAuctionFloorPrice] = useState<bigint | null>(null);
  const [auctionParticipationFee, setAuctionParticipationFee] = useState<bigint | null>(null);
  const [auctionMinIncrement, setAuctionMinIncrement] = useState<bigint | null>(null);
  const [auctionWinner, setAuctionWinner] = useState("");
  const [auctionFinalized, setAuctionFinalized] = useState<boolean | null>(null);
  const [auctionPaused, setAuctionPaused] = useState<boolean | null>(null);
  const [auctionTimeRemaining, setAuctionTimeRemaining] = useState<bigint | null>(null);
  const [auctionBidderCount, setAuctionBidderCount] = useState<number | null>(null);
  const [hasPaidParticipationFee, setHasPaidParticipationFee] = useState(false);

  // User State
  const [userBid, setUserBid] = useState<bigint | null>(null);
  const [userUsdcBalance, setUserUsdcBalance] = useState<bigint | null>(null);
  const [userUsdcAllowance, setUserUsdcAllowance] = useState<bigint | null>(null);

  // UI State
  const [toasts, setToasts] = useState<Toast[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [lastRefreshed, setLastRefreshed] = useState<Date | null>(null);
  const [bidInput, setBidInput] = useState("");
  const [bidError, setBidError] = useState<string | null>(null);

  const isLeader = hasSession && auctionLeader && walletAddress!.toLowerCase() === auctionLeader.toLowerCase();
  const isWinner = hasSession && auctionWinner && walletAddress!.toLowerCase() === auctionWinner.toLowerCase();
  const canBid = hasSession && !auctionFinalized && !auctionPaused && auctionPhase !== null && auctionPhase <= 2;
  const canWithdraw = hasSession && userBid !== null && userBid > 0n && !isLeader && !isWinner;

  // ============ TOAST ============

  const pushToast = useCallback((toast: Omit<Toast, "id">) => {
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    setToasts((prev) => [...prev, { ...toast, id }]);
    setTimeout(() => setToasts((prev) => prev.filter((t) => t.id !== id)), 5000);
  }, []);

  // Determine auction address - must come from URL parameter
  const auctionAddress = useMemo((): `0x${string}` | null => {
    if (auctionAddressParam && isAddress(auctionAddressParam)) {
      return auctionAddressParam as `0x${string}`;
    }
    return null;
  }, [auctionAddressParam]);

  // ============ REFRESH DATA ============

  const refreshData = useCallback(async () => {
    if (!auctionAddress) return;
    
    try {
      const results = await publicClient.multicall({
        contracts: [
          { address: auctionAddress, abi: auctionAbi, functionName: "currentPhase" },
          { address: auctionAddress, abi: auctionAbi, functionName: "currentLeader" },
          { address: auctionAddress, abi: auctionAbi, functionName: "currentHighBid" },
          { address: auctionAddress, abi: auctionAbi, functionName: "floorPrice" },
          { address: auctionAddress, abi: auctionAbi, functionName: "participationFee" },
          { address: auctionAddress, abi: auctionAbi, functionName: "minBidIncrement" },
          { address: auctionAddress, abi: auctionAbi, functionName: "winner" },
          { address: auctionAddress, abi: auctionAbi, functionName: "finalized" },
          { address: auctionAddress, abi: auctionAbi, functionName: "paused" },
          { address: auctionAddress, abi: auctionAbi, functionName: "getTimeRemaining" },
          { address: auctionAddress, abi: auctionAbi, functionName: "getBidderCount" },
        ],
      });

      setAuctionPhase(results[0].result != null ? Number(results[0].result) : null);
      setAuctionLeader((results[1].result as string) ?? "");
      setAuctionHighBid(results[2].result as bigint ?? null);
      setAuctionFloorPrice(results[3].result as bigint ?? null);
      setAuctionParticipationFee(results[4].result as bigint ?? 0n);
      setAuctionMinIncrement(results[5].result as bigint ?? 0n);
      setAuctionWinner((results[6].result as string) ?? "");
      setAuctionFinalized(results[7].result as boolean ?? null);
      setAuctionPaused(results[8].result as boolean ?? null);
      setAuctionTimeRemaining(results[9].result as bigint ?? 0n);
      setAuctionBidderCount(results[10].result != null ? Number(results[10].result) : null);

      if (walletAddress) {
        const userResults = await publicClient.multicall({
          contracts: [
            { address: auctionAddress, abi: auctionAbi, functionName: "userBids", args: [walletAddress] },
            { address: auctionAddress, abi: auctionAbi, functionName: "hasPaidFee", args: [walletAddress] },
            { address: contracts.USDC, abi: erc20Abi, functionName: "balanceOf", args: [walletAddress] },
            { address: contracts.USDC, abi: erc20Abi, functionName: "allowance", args: [walletAddress, auctionAddress] },
          ],
        });

        setUserBid(userResults[0].result as bigint ?? null);
        setHasPaidParticipationFee((userResults[1].result as boolean) ?? false);
        setUserUsdcBalance(userResults[2].result as bigint ?? null);
        setUserUsdcAllowance(userResults[3].result as bigint ?? null);
      }

      setLastRefreshed(new Date());
    } catch (error) {
      console.error("Failed to load auction data:", error);
    }
  }, [publicClient, walletAddress, auctionAddress]);

  useEffect(() => {
    refreshData();
  }, [refreshData]);

  // ============ APPROVE USDC ============

  const handleApproveUsdc = async () => {
    const amount = parseFloat(bidInput);
    if (isNaN(amount) || amount <= 0) {
      pushToast({ type: "error", title: "Enter a valid amount first" });
      return;
    }

    setIsLoading(true);
    try {
      const approveAmount = parseUnits((amount * 2).toFixed(6), 6);
      pushToast({ type: "info", title: "Approve USDC pending...", detail: "Approve in your wallet" });

      const hash = await writeContractAsync({
        address: contracts.USDC,
        abi: erc20Abi,
        functionName: "approve",
        args: [auctionAddress, approveAmount],
      });

      pushToast({ type: "success", title: "Approve USDC confirmed!", detail: hash ? `TX: ${hash.slice(0, 14)}...` : undefined });
      await refreshData();
    } catch (error) {
      const msg = error instanceof Error ? error.message : "Transaction failed";
      pushToast({ type: "error", title: "Approve USDC", detail: msg });
    } finally {
      setIsLoading(false);
    }
  };

  // ============ PAY PARTICIPATION FEE ============

  const handlePayParticipationFee = async () => {
    if (!hasSession) {
      router.push("/");
      return;
    }

    if (auctionParticipationFee === null || auctionParticipationFee === 0n) {
      pushToast({ type: "info", title: "No participation fee required" });
      return;
    }

    if (userUsdcBalance !== null && auctionParticipationFee > userUsdcBalance) {
      pushToast({ type: "error", title: `Insufficient balance. Need ${formatUsdc(auctionParticipationFee)} USDC` });
      return;
    }

    setIsLoading(true);
    try {
      if (userUsdcAllowance !== null && auctionParticipationFee > userUsdcAllowance) {
        pushToast({ type: "info", title: "Approving USDC..." });
        await writeContractAsync({
          address: contracts.USDC,
          abi: erc20Abi,
          functionName: "approve",
          args: [auctionAddress, auctionParticipationFee * 2n],
        });
        await refreshData();
      }

      pushToast({ type: "info", title: "Pay Participation Fee pending...", detail: "Approve in your wallet" });
      const hash = await writeContractAsync({
        address: auctionAddress,
        abi: auctionAbi,
        functionName: "payParticipationFee",
      });

      pushToast({ type: "success", title: "Pay Participation Fee confirmed!", detail: hash ? `TX: ${hash.slice(0, 14)}...` : undefined });
      await refreshData();
    } catch (error) {
      const msg = error instanceof Error ? error.message : "Transaction failed";
      pushToast({ type: "error", title: "Pay Participation Fee", detail: msg });
    } finally {
      setIsLoading(false);
    }
  };

  // ============ PLACE BID ============

  const handlePlaceBid = async () => {
    setBidError(null);

    if (!hasSession) {
      router.push("/");
      return;
    }

    if (auctionParticipationFee !== null && auctionParticipationFee > 0n && !hasPaidParticipationFee) {
      setBidError(`You must pay the participation fee of ${formatUsdc(auctionParticipationFee)} USDC first.`);
      return;
    }

    const amount = parseFloat(bidInput);
    if (isNaN(amount) || amount <= 0) {
      setBidError("Enter a valid bid amount.");
      return;
    }

    const bidAmount = parseUnits(amount.toFixed(6), 6);

    if (userUsdcBalance !== null && bidAmount > userUsdcBalance) {
      setBidError(`Insufficient USDC balance. You have ${formatUsdc(userUsdcBalance)} USDC.`);
      return;
    }

    if (userUsdcAllowance !== null && bidAmount > userUsdcAllowance) {
      setBidError("Please approve USDC first.");
      return;
    }

    const currentUserBid = userBid ?? 0n;
    const newTotalBidCalc = currentUserBid + bidAmount;

    if (auctionFloorPrice !== null && newTotalBidCalc < auctionFloorPrice) {
      setBidError(`Your total bid must be at least ${formatUsdc(auctionFloorPrice)} USDC (floor price).`);
      return;
    }

    if (auctionHighBid !== null && !isLeader && newTotalBidCalc <= auctionHighBid) {
      const minRequired = auctionHighBid + (auctionHighBid * 5n / 100n);
      setBidError(`Your total bid must exceed ${formatUsdc(minRequired)} USDC to become the leader.`);
      return;
    }

    setIsLoading(true);
    try {
      pushToast({ type: "info", title: "Place Bid pending...", detail: "Approve in your wallet" });
      const hash = await writeContractAsync({
        address: auctionAddress,
        abi: auctionAbi,
        functionName: "placeBid",
        args: [bidAmount],
      });

      pushToast({ type: "success", title: "Place Bid confirmed!", detail: hash ? `TX: ${hash.slice(0, 14)}...` : undefined });
      setBidInput("");
      await refreshData();
    } catch (error) {
      const msg = error instanceof Error ? error.message : "Transaction failed";
      pushToast({ type: "error", title: "Place Bid", detail: msg });
    } finally {
      setIsLoading(false);
    }
  };

  // ============ WITHDRAW BID ============

  const handleWithdrawBid = async () => {
    if (!canWithdraw) {
      pushToast({ type: "error", title: "Cannot withdraw - you may be the leader" });
      return;
    }

    setIsLoading(true);
    try {
      pushToast({ type: "info", title: "Withdraw Bid pending...", detail: "Approve in your wallet" });
      const hash = await writeContractAsync({
        address: auctionAddress,
        abi: auctionAbi,
        functionName: "withdrawBid",
      });

      pushToast({ type: "success", title: "Withdraw Bid confirmed!", detail: hash ? `TX: ${hash.slice(0, 14)}...` : undefined });
      await refreshData();
    } catch (error) {
      const msg = error instanceof Error ? error.message : "Transaction failed";
      pushToast({ type: "error", title: "Withdraw Bid", detail: msg });
    } finally {
      setIsLoading(false);
    }
  };

  // ============ COMPUTED VALUES ============

  const bidAmountParsed = parseFloat(bidInput) || 0;
  const bidAmountWei = parseUnits(bidAmountParsed.toFixed(6), 6);
  const needsApproval = userUsdcAllowance !== null && bidAmountWei > userUsdcAllowance;
  const newTotalBid = (userBid ?? 0n) + bidAmountWei;

  return (
    <div className={`min-h-screen ${ui.bg} text-white`}>
      <Header />

      <div className="mx-auto max-w-5xl px-4 py-8">
        {/* Wallet Status Banner */}
        <WalletStatusBanner
          connectionStatus={connectionStatus}
          isChainMismatch={isChainMismatch}
          chainName={chainMeta.chainName}
          onSwitchChain={() => switchToChain(activeChainId)}
          isSwitching={isSwitching}
        />

        {/* Header */}
        <div className="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between mb-6">
          <div className="min-w-0">
            <button
              onClick={() => router.push("/auctions")}
              className="inline-flex items-center gap-1.5 text-sm text-white/50 hover:text-white/80 mb-2"
            >
              <span>&larr;</span> Back to Auctions
            </button>
            <div className="inline-flex items-center gap-2 rounded-full border border-white/8 bg-white/3 px-3 py-1 text-xs text-white/75">
              <IconShield className="h-4 w-4 text-[#7DEAEA]" />
              Live Auction - On-Chain
            </div>
            <h1 className="mt-3 text-3xl font-semibold tracking-tight">
              Property Auction
            </h1>
            <p className="mt-1 text-sm text-white/55">
              Bid with USDC on {chainMeta.chainName}
            </p>
          </div>
        </div>

        {/* Error: No auction address */}
        {!auctionAddress && (
          <div className={`rounded-3xl ${ui.card} p-8 text-center`}>
            <div className="text-red-400 text-lg font-semibold mb-2">Invalid Auction</div>
            <p className="text-white/60 mb-4">No auction address provided in the URL.</p>
            <button
              onClick={() => router.push("/auctions")}
              className="rounded-xl bg-cyan-500 px-6 py-3 font-semibold text-black hover:brightness-110"
            >
              View All Auctions
            </button>
          </div>
        )}

        {/* Main Grid */}
        {auctionAddress && (
        <div className="grid gap-6 lg:grid-cols-3">
          {/* Left: Auction Info & Bidding */}
          <div className="lg:col-span-2 space-y-6">
            {/* Auction Status */}
            <div className={`rounded-3xl ${ui.card} p-6`}>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold">Auction Status</h2>
                <div className="flex items-center gap-2">
                  <button
                    onClick={refreshData}
                    className="rounded-lg border border-white/10 bg-white/5 px-3 py-1.5 text-xs hover:bg-white/10"
                  >
                    Refresh
                  </button>
                  {lastRefreshed && (
                    <span className="text-xs text-white/40">
                      {lastRefreshed.toLocaleTimeString()}
                    </span>
                  )}
                </div>
              </div>

              <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <div className={`rounded-2xl ${ui.cardInner} p-4 sm:col-span-2 lg:col-span-3`}>
                  <div className="text-xs text-white/50 mb-2">Auction Contract</div>
                  <a
                    href={`${chainMeta.explorer}/address/${auctionAddress}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="font-mono text-sm text-cyan-400 hover:underline flex items-center gap-2"
                  >
                    {auctionAddress}
                    <svg className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4 sm:col-span-2 lg:col-span-3`}>
                  <div className="text-xs text-white/50 mb-2">Current Phase</div>
                  {auctionPhase !== null ? (
                    <PhaseProgressBar phase={auctionPhase} variant="expanded" />
                  ) : (
                    <div className="text-lg font-semibold text-cyan-400">-</div>
                  )}
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">High Bid</div>
                  <div className="text-lg font-semibold text-emerald-400">
                    {formatUsdc(auctionHighBid)} USDC
                  </div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Current Leader</div>
                  <div className="text-sm font-mono text-white/80">
                    {isLeader ? (
                      <span className="text-emerald-400">You!</span>
                    ) : (
                      shortAddr(auctionLeader)
                    )}
                  </div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Time Remaining</div>
                  <div className="flex items-center gap-2">
                    <IconClock className="h-4 w-4 text-cyan-400" />
                    <span className="font-semibold">{formatTimeRemaining(auctionTimeRemaining)}</span>
                  </div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Floor Price</div>
                  <div className="text-sm font-semibold">{formatUsdc(auctionFloorPrice)} USDC</div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Participation Fee</div>
                  <div className="text-sm font-semibold">{formatUsdc(auctionParticipationFee)} USDC</div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Min Increment</div>
                  <div className="text-sm font-semibold">{auctionMinIncrement ? `${auctionMinIncrement}%` : "-"}</div>
                </div>

                <div className={`rounded-2xl ${ui.cardInner} p-4`}>
                  <div className="text-xs text-white/50 mb-1">Total Bidders</div>
                  <div className="text-sm font-semibold">{auctionBidderCount ?? "-"}</div>
                </div>
              </div>

              {/* Status indicators */}
              <div className="flex flex-wrap gap-2 mt-4">
                {auctionFinalized && (
                  <span className="rounded-full bg-emerald-500/20 text-emerald-300 px-3 py-1 text-xs">
                    Auction Finalized
                  </span>
                )}
                {auctionPaused && (
                  <span className="rounded-full bg-red-500/20 text-red-300 px-3 py-1 text-xs">
                    Auction Paused
                  </span>
                )}
                {auctionWinner && auctionWinner !== zeroAddress && (
                  <span className="rounded-full bg-cyan-500/20 text-cyan-300 px-3 py-1 text-xs">
                    Winner: {shortAddr(auctionWinner)}
                  </span>
                )}
              </div>
            </div>

            {/* Place Bid Section */}
            <div className={`rounded-3xl ${ui.card} p-6`}>
              <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <IconGavel className="h-5 w-5 text-cyan-400" />
                Place Your Bid
              </h2>

              {!hasSession ? (
                <div className="text-center py-8">
                  <p className="text-white/60 mb-4">Connect your wallet to start bidding</p>
                  <button
                    onClick={() => router.push("/")}
                    className="rounded-xl bg-cyan-500 px-6 py-3 font-semibold text-black hover:brightness-110"
                  >
                    Connect Wallet
                  </button>
                </div>
              ) : auctionFinalized ? (
                <div className="text-center py-8">
                  <p className="text-white/60">This auction has ended.</p>
                  {isWinner && (
                    <p className="text-emerald-400 mt-2 font-semibold">Congratulations! You won!</p>
                  )}
                </div>
              ) : auctionPaused ? (
                <div className="text-center py-8">
                  <p className="text-amber-400">Bidding is temporarily paused.</p>
                </div>
              ) : (
                <>
                  {/* Participation Fee Warning */}
                  {auctionParticipationFee !== null && auctionParticipationFee > 0n && !hasPaidParticipationFee && (
                    <div className="mb-4 rounded-2xl border border-yellow-500/30 bg-yellow-500/10 p-4">
                      <div className="flex items-center gap-3">
                        <div className="rounded-full bg-yellow-500/20 p-2">
                          <IconShield className="h-5 w-5 text-yellow-400" />
                        </div>
                        <div className="flex-1">
                          <div className="text-sm font-semibold text-yellow-400">Participation Fee Required</div>
                          <div className="text-xs text-yellow-300/80 mt-1">
                            Pay {formatUsdc(auctionParticipationFee)} USDC to participate in this auction
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={handlePayParticipationFee}
                        disabled={isLoading}
                        className="mt-3 w-full rounded-lg bg-yellow-500 px-4 py-2 text-sm font-semibold text-black hover:brightness-110 disabled:opacity-50"
                      >
                        {isLoading ? "Processing..." : `Pay ${formatUsdc(auctionParticipationFee)} USDC Fee`}
                      </button>
                    </div>
                  )}

                  {/* Fee Paid Status */}
                  {hasPaidParticipationFee && auctionParticipationFee !== null && auctionParticipationFee > 0n && (
                    <div className="mb-4 rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-3">
                      <div className="flex items-center gap-2 text-sm text-emerald-400">
                        <IconShield className="h-4 w-4" />
                        <span className="font-semibold">Participation fee paid</span>
                      </div>
                    </div>
                  )}

                  {/* Your current bid */}
                  {userBid !== null && userBid > 0n && (
                    <div className="mb-4 rounded-2xl border border-cyan-500/30 bg-cyan-500/10 p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-xs text-cyan-300">Your Current Bid</div>
                          <div className="text-xl font-bold text-cyan-400">{formatUsdc(userBid)} USDC</div>
                        </div>
                        {isLeader && (
                          <span className="rounded-full bg-emerald-500/20 text-emerald-300 px-3 py-1 text-sm font-semibold">
                            You&apos;re Leading!
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Bid input */}
                  <div className="space-y-4">
                    <div>
                      <label className="text-xs text-white/50 mb-2 block">
                        Add to your bid (USDC)
                      </label>
                      <div className="relative">
                        <input
                          type="number"
                          min="0"
                          step="0.01"
                          placeholder="Enter amount..."
                          value={bidInput}
                          onChange={(e) => {
                            setBidInput(e.target.value);
                            setBidError(null);
                          }}
                          className="w-full rounded-xl border border-white/10 bg-black/30 px-4 py-3 text-lg outline-none focus:border-cyan-500/60"
                        />
                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-white/40">
                          USDC
                        </div>
                      </div>
                    </div>

                    {bidAmountParsed > 0 && (
                      <div className="text-sm text-white/60">
                        New total bid: <span className="text-cyan-400 font-semibold">{formatUsdc(newTotalBid)} USDC</span>
                      </div>
                    )}

                    {bidError && (
                      <div className="text-sm text-red-400">{bidError}</div>
                    )}

                    {/* Balance info */}
                    <div className="flex flex-wrap gap-4 text-xs text-white/50">
                      <span>Balance: {formatUsdc(userUsdcBalance)} USDC</span>
                      <span>Allowance: {formatUsdc(userUsdcAllowance)} USDC</span>
                    </div>

                    {/* Action buttons */}
                    <div className="flex flex-col sm:flex-row gap-3">
                      {needsApproval && bidAmountParsed > 0 ? (
                        <button
                          onClick={handleApproveUsdc}
                          disabled={isLoading}
                          className="flex-1 group inline-flex items-center justify-center gap-2 rounded-xl bg-amber-500 px-5 py-3 font-semibold text-black transition hover:brightness-110 disabled:opacity-50"
                        >
                          {isLoading ? (
                            <>
                              <div className="h-5 w-5 animate-spin rounded-full border-2 border-black/20 border-t-black"></div>
                              <span>Approving...</span>
                            </>
                          ) : (
                            <>
                              <IconShield className="h-5 w-5" />
                              <span>Approve USDC</span>
                            </>
                          )}
                        </button>
                      ) : (
                        <button
                          onClick={handlePlaceBid}
                          disabled={isLoading || !bidAmountParsed || (auctionParticipationFee !== null && auctionParticipationFee > 0n && !hasPaidParticipationFee)}
                          className="flex-1 group inline-flex items-center justify-center gap-2 rounded-xl bg-cyan-500 px-5 py-3 font-semibold text-black transition hover:brightness-110 disabled:opacity-50"
                        >
                          {isLoading ? (
                            <>
                              <div className="h-5 w-5 animate-spin rounded-full border-2 border-black/20 border-t-black"></div>
                              <span>Processing...</span>
                            </>
                          ) : (
                            <>
                              <IconGavel className="h-5 w-5" />
                              <span>Place Bid</span>
                            </>
                          )}
                        </button>
                      )}

                      {canWithdraw && (
                        <button
                          onClick={handleWithdrawBid}
                          disabled={isLoading}
                          className="inline-flex items-center justify-center gap-2 rounded-xl border border-red-500/50 bg-red-500/10 px-5 py-3 font-semibold text-red-300 transition hover:bg-red-500/20 disabled:opacity-50"
                        >
                          <IconWithdraw className="h-5 w-5" />
                          Withdraw Bid
                        </button>
                      )}
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* Right: Wallet & Info */}
          <div className="space-y-6">
            {/* Wallet Card */}
            <div className={`rounded-3xl ${ui.card} p-5`}>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2 text-sm text-white/70">
                  <IconWallet className="h-4 w-4 text-cyan-400" />
                  My Wallet
                </div>
                <button
                  onClick={() => router.push(hasSession ? "/account" : "/")}
                  className={`rounded-xl px-3 py-1.5 text-xs ${ui.pillMuted} hover:bg-white/6`}
                >
                  {hasSession ? "View" : "Connect"}
                </button>
              </div>

              {hasSession && walletAddress ? (
                <div className="space-y-3">
                  <div className={`rounded-2xl ${ui.cardInner} p-3`}>
                    <div className="text-[11px] text-white/50">Address</div>
                    <div className="text-sm font-mono text-white/85">{shortAddr(walletAddress)}</div>
                  </div>
                  <div className={`rounded-2xl ${ui.cardInner} p-3`}>
                    <div className="text-[11px] text-white/50">USDC Balance</div>
                    <div className="text-sm font-semibold text-white/85">
                      {formatUsdc(userUsdcBalance)} USDC
                    </div>
                  </div>
                  <div className={`rounded-2xl ${ui.cardInner} p-3`}>
                    <div className="text-[11px] text-white/50">Your Bid</div>
                    <div className="text-sm font-semibold text-cyan-400">
                      {userBid && userBid > 0n ? `${formatUsdc(userBid)} USDC` : "No bid yet"}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="text-sm text-white/50">
                  Connect your wallet to participate in the auction.
                </div>
              )}
            </div>

            {/* How It Works */}
            <div className={`rounded-3xl ${ui.card} p-5`}>
              <h3 className="text-sm font-semibold mb-3">How Bidding Works</h3>
              <ul className="space-y-2 text-xs text-white/60">
                <li className="flex gap-2">
                  <span className="text-cyan-400">1.</span>
                  <span>Bids are cumulative - each bid adds to your total</span>
                </li>
                <li className="flex gap-2">
                  <span className="text-cyan-400">2.</span>
                  <span>Only the winner pays; losers get full refunds</span>
                </li>
                <li className="flex gap-2">
                  <span className="text-cyan-400">3.</span>
                  <span>You can withdraw your bid anytime (unless leading)</span>
                </li>
                <li className="flex gap-2">
                  <span className="text-cyan-400">4.</span>
                  <span>Auction progresses through 3 reveal phases</span>
                </li>
              </ul>
            </div>

            {/* Contract Info */}
            <div className={`rounded-3xl ${ui.card} p-5`}>
              <h3 className="text-sm font-semibold mb-3">Contract Info</h3>
              <div className="space-y-2 text-xs">
                <div className="flex justify-between">
                  <span className="text-white/50">Auction</span>
                  <a
                    href={`${chainMeta.explorer}/address/${auctionAddress}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="font-mono text-cyan-400 hover:underline"
                  >
                    {shortAddr(auctionAddress)}
                  </a>
                </div>
                {auctionAddressParam && (
                  <div className="text-[10px] text-white/40 text-right">
                    Custom auction
                  </div>
                )}
                <div className="flex justify-between">
                  <span className="text-white/50">USDC</span>
                  <a
                    href={`${chainMeta.explorer}/address/${contracts.USDC}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="font-mono text-cyan-400 hover:underline flex items-center gap-1"
                  >
                    {shortAddr(contracts.USDC)}
                    <svg className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                </div>
                <div className="flex justify-between">
                  <span className="text-white/50">Network</span>
                  <span className="text-white/80">{chainMeta.chainName}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        )}
      </div>

      {/* Toasts */
      <div className="fixed right-4 top-20 z-50 space-y-2">
        {toasts.map((t) => (
          <div
            key={t.id}
            className={`rounded-lg px-4 py-3 text-sm shadow-lg ${
              t.type === "error"
                ? "bg-red-500/90 text-white"
                : t.type === "success"
                ? "bg-emerald-500/90 text-white"
                : "bg-white/10 text-white backdrop-blur"
            }`}
          >
            <div className="font-medium">{t.title}</div>
            {t.detail && <div className="text-xs opacity-80 mt-1">{t.detail}</div>}
          </div>
        ))}
      </div>

      {/* Loading Overlay */}
      {isLoading && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/50 backdrop-blur-sm">
          <div className="rounded-xl bg-white/10 px-6 py-4 text-sm">
            <div className="flex items-center gap-3">
              <div className="h-5 w-5 animate-spin rounded-full border-2 border-cyan-400 border-t-transparent" />
              Processing transaction...
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function AuctionLoadingFallback() {
  return (
    <div className="min-h-screen bg-[#07090A] text-white flex items-center justify-center">
      <div className="text-center">
        <div className="inline-block h-8 w-8 animate-spin rounded-full border-2 border-cyan-400 border-t-transparent mb-4" />
        <div className="text-lg opacity-80">Loading auction...</div>
      </div>
    </div>
  );
}

export default function AuctionBidPage() {
  return (
    <Suspense fallback={<AuctionLoadingFallback />}>
      <AuctionBidPageContent />
    </Suspense>
  );
}
